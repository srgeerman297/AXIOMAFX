<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AXIOMA FX Comparator</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0A4FB4">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="AXIOMA FX">
  <link rel="apple-touch-icon" href="icons/icon-180.png">

  <!-- UI libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/htm@3.1.1/dist/htm.umd.js"></script>

  <style>
    :root{ --ax:#0A4FB4; --ax50:#E8F1FF; --ax200:#CFE0FF; }
    body{ background:#f8fafc; color:#0f172a; }
    .card{ border:1px solid var(--ax200); border-radius:1rem; background:#fff; }
  </style>
</head>
<body>
  <noscript>
    <div style="padding:16px;margin:16px;border:1px solid #ccc;border-radius:12px;background:#fff">
      This app needs JavaScript enabled.
    </div>
  </noscript>

  <div id="root" class="p-4 max-w-5xl mx-auto"></div>
  <pre id="fatal" class="hidden m-4 p-3 text-xs card text-rose-700"></pre>

  <script>
  (function(){
    // bind HTM
    const html = htm.bind(React.createElement);
    const { useState, useEffect, useMemo } = React;

    // tiny helpers
    const AWG_PEG = 1.79;
    const parseNum = v => (isFinite(+v) ? +v : 0);
    const fmt = (n,c="AWG") => {
      try { return new Intl.NumberFormat(undefined,{style:"currency",currency:c}).format(+n||0); }
      catch { return (+n||0).toFixed(2); }
    };

    // component
    function App(){
      const [awg,setAwg] = useState(AWG_PEG);
      const [srd,setSrd] = useState(0);
      const [fxErr,setFxErr] = useState("");

      const usdToAwg = usd => usd * (awg || 0);
      const srdToAwg = s  => s * (awg / (srd || 1));

      const [row,setRow] = useState({
        name:"Apple AirPods Max",
        arubaPriceAwg:1369, arubaExtraAwg:0, arubaTaxPct:0,
        surinamePriceSrd:21725, surinameExtraSrd:0, surinameTaxPct:0,
        amazonPriceUsd:479.99, amazonShippingUsd:100, amazonTaxPct:0
      });

      function totals(){
        const aruba = (parseNum(row.arubaPriceAwg)+parseNum(row.arubaExtraAwg))*(1+parseNum(row.arubaTaxPct)/100);
        const suriPre = parseNum(row.surinamePriceSrd)+parseNum(row.surinameExtraSrd);
        const suriname = srd ? srdToAwg(suriPre*(1+parseNum(row.surinameTaxPct)/100)) : 0;
        const amaPre = parseNum(row.amazonPriceUsd)+parseNum(row.amazonShippingUsd);
        const amazon = usdToAwg(amaPre*(1+parseNum(row.amazonTaxPct)/100));
        const list = [{k:"Aruba",v:aruba},{k:"Suriname",v:suriname},{k:"Amazon",v:amazon}].filter(x=>x.v>0);
        let cheapest="—", s2=0, sh=0;
        if (list.length){
          const sorted = list.slice().sort((a,b)=>a.v-b.v);
          cheapest = sorted[0].k;
          if (sorted.length>=2){ s2 = sorted[1].v - sorted[0].v; sh = sorted[sorted.length-1].v - sorted[0].v; }
        }
        return {aruba,suriname,amazon,cheapest,s2,sh};
      }

      async function refreshFX(){
        try{
          setFxErr("");
          const res = await fetch("https://open.er-api.com/v6/latest/USD",{cache:"no-store"});
          if(!res.ok) throw new Error("HTTP "+res.status);
          const d = await res.json();
          const SRD = +((d && d.rates && d.rates.SRD) || 0);
          if(!isFinite(SRD) || SRD<=0) throw new Error("SRD missing");
          setAwg(AWG_PEG); setSrd(SRD);
        }catch(e){ setFxErr(String(e.message||e)); }
      }

      useEffect(()=>{ refreshFX(); },[]);

      const t = totals();

      return html`
        <div class="space-y-4">
          <header class="flex items-end justify-between">
            <div>
              <h1 class="text-2xl font-semibold" style="color:var(--ax)">Live FX Price Comparator</h1>
              <p class="text-sm text-slate-600">GH Pages build (debug visible on errors).</p>
            </div>
            <button class="px-3 py-2 rounded-xl shadow text-white" style="background:var(--ax)"
              onClick=${refreshFX}>Refresh FX</button>
          </header>

          <div class="card p-4">
            <div class="text-sm grid grid-cols-2 gap-1">
              <div class="text-slate-500">USD→AWG</div><div>${awg.toFixed(4)}</div>
              <div class="text-slate-500">USD→SRD</div><div>${srd? srd.toFixed(4) : "—"}</div>
            </div>
            ${fxErr && html`<div class="mt-2 text-xs text-rose-600">FX error: ${fxErr}</div>`}
          </div>

          <div class="grid gap-2 sm:grid-cols-4">
            <div class="card p-3"><div class="text-xs text-slate-600">Total Aruba (AWG)</div><div class="font-medium">${fmt(t.aruba)}</div></div>
            <div class="card p-3"><div class="text-xs text-slate-600">Total Suriname (AWG)</div><div class="font-medium">${fmt(t.suriname)}</div></div>
            <div class="card p-3"><div class="text-xs text-slate-600">Total Amazon (AWG)</div><div class="font-medium">${fmt(t.amazon)}</div></div>
            <div class="card p-3">
              <div class="text-xs">Decision</div>
              <div class="font-medium" style="color:var(--ax)">${t.cheapest}</div>
              <div class="text-xs text-slate-600">Saves ${fmt(t.s2)} vs next-best</div>
              <div class="text-xs text-slate-600">Saves ${fmt(t.sh)} vs highest</div>
            </div>
          </div>
        </div>
      `;
    }

    // Render with visible fatal error fallback
    try{
      const rootEl = document.getElementById('root');
      ReactDOM.createRoot(rootEl).render(React.createElement(App));
    }catch(err){
      const p = document.getElementById('fatal');
      p.classList.remove('hidden');
      p.textContent = 'Fatal render error: ' + (err && err.message ? err.message : String(err));
      console.error(err);
    }
  })();
  </script>

  <!-- Register SW (plain relative path) -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function () {
        navigator.serviceWorker.register('sw.js').catch(function (e) {
          console.log('SW registration failed:', e);
          const p = document.getElementById('fatal');
          p.classList.remove('hidden');
          p.textContent = 'SW registration failed: ' + e;
        });
      });
    }
  </script>
</body>
</html>
